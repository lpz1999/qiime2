本教程中使用的数据来自[2017年发表于Microbiome上关于粪便微生物移植（粪菌移植）改善自闭症的研究(Microbiota Transfer Therapy alters gut ecosystem and improves gastrointestinal and autism symptoms: an open-label study)](http://doi.org/10.1186/s40168-016-0225-7)，详见《[Microbiome：粪菌移植改善自闭症](https://mp.weixin.qq.com/s/VXy9haFsnnMVlyXLULy52w)》。其中18岁以下患有自闭症和胃肠道疾病的儿童，分别通过自闭症诊断访谈修订版(ADI-R)和胃肠道症状评定量表(GSRS)测量，用粪便微生物移植治疗，试图减少他们的行为异常和胃肠道症状的严重程度。我们通过18周内他们的GSRS评分追踪了他们的微生物变化，包括父母的整体状况III（Parent Global Impressions，PGI-III）和儿童孤独症评定量表（CARS），以及他们胃肠道症状的严重程度。通过每周收集粪便拭子样本（用擦拭用过的卫生纸收集）和不太频繁的大便样本（收集全大便）来跟踪微生物群。在全部研究中，这是第一阶段的临床试验，旨在测试治疗的安全性，18个人接受了治疗，20个人作为对照。对照组未接受治疗，但监测肠道微生物群的正常时间变化。本研究还对治疗期间移植的粪便材料进行了测序。

本教程数据集是为本研究数据的一个子集。它包括五个接受治疗的个体和五个对照的数据。每个个体包括6至16个样本，包括每个个体的大便和粪便拭子样本，以及FMT治疗前后样本。移植的粪便材料也包括五个样本。

这些数据是在两次Illumina MiSeq测序批次（Run）中测序。如《人体各部位微生物组教程》所示，我们将使用[DADA2](https://www.ncbi.nlm.nih.gov/pubmed/27214047)执行初始质量控制并生成`FeatureTable[Frequency]`和`FeatureData[Sequence]`对象。然而，**DADA2去噪过程只适用于一次单个测序批次，因此我们需要在每个测序批次的基础上运行该过程，然后合并结果**。我们将完成这个初始步骤，然后提出一些可以作为练习来回答的问题。


## 实验设计简介

![image](http://bailab.genetics.ac.cn/markdown/note/FMT1.jpg)

本实验研究自闭症且胃肠道功能紊乱患者，采用粪便菌群移植方法，来降低患者的行为异常和肠道紊乱。监测移植后18个月范围内肠道菌群的变化，上图为[Microbiome原文中实验设计](http://doi.org/10.1186/s40168-016-0225-7)。  

## 启动QIIME2运行环境

```
# 定义工作目录变量，方便以后多次使用
wd=~/github/lpz1999/qiime2
mkdir -p $wd
cd $wd
conda activate qiime2-2022.2
# 创建本节学习目录
mkdir -p fmt
cd fmt
```

## 实验数据下载
**Obtain data files**
下载元数据，即描述样本的数据，也称实验设计。通过上述方法下载请跳过。
```
wget -c http://210.75.224.110/github/QIIME2ChineseManual/2021.2/fmt/sample-metadata.tsv
```

下载本分析中使用的拆分好的混合样本序列。我们需要下载两组样本拆分好的序列，每个序列文件对应一个序列测序批次。

**这里我们选择10%的子集序列用于后序列分析。**
因为10%的子集序列也非常少，才几十M，注意文件名要手动删除`-10p`部分。

```
# 20M，about 30s
wget \
  -O "fmt-tutorial-demux-1.qza" \
  "https://data.qiime2.org/2021.2/tutorials/fmt/fmt-tutorial-demux-1-10p.qza"
wget \
  -O "fmt-tutorial-demux-2.qza" \
  "https://data.qiime2.org/2021.2/tutorials/fmt/fmt-tutorial-demux-2-10p.qza"
```

## 序列质控评估
**Sequence quality control**

使用[DADA2](https://www.ncbi.nlm.nih.gov/pubmed/27214047)对对每组样本拆分后序列分别运行`denoise-single`(单端去噪)命令。同样，我们希望可视化每批次中样本的序列质量。
当我们运行`denoise-single`命令时，我们需要为两次分析`--p-trunc-len`和`--p-trim-left`使用相同的参数值。
当查看这两个命令产生的可视化时，只有两个命令基于相同的参数分析结果进行比较才有意义，否则多变量因素导致混淆。

**样本拆分结果的统计**
```
qiime demux summarize \
  --i-data fmt-tutorial-demux-1.qza \
  --o-visualization demux-summary-1.qzv
qiime demux summarize \
  --i-data fmt-tutorial-demux-2.qza \
  --o-visualization demux-summary-2.qzv
```

## 生成特征表和代表性序列
前几个碱基的质量似乎相对较低，然后似乎保持相对较高，直到序列测序结束。因此，我们将从每个序列中修剪前13个碱基，并在150个碱基处截断这些碱基。由于读数是151个碱基，这导致序列的截断非常少。
dada2质控和去冗余，本实验有两批独立的数据，需要处理两次，生成代表序列和特征表

```
# 去噪生成特征表，笔记本：1m28s，服务器：2m44s
time qiime dada2 denoise-single \
  --p-trim-left 13 \
  --p-trunc-len 150 \
  --i-demultiplexed-seqs fmt-tutorial-demux-1.qza \
  --o-representative-sequences rep-seqs-1.qza \
  --o-table table-1.qza \
  --o-denoising-stats stats-1.qza
# 去噪生成特征表，笔记本：48s，服务器：1m27s
time qiime dada2 denoise-single \
  --p-trim-left 13 \
  --p-trunc-len 150 \
  --i-demultiplexed-seqs fmt-tutorial-demux-2.qza \
  --o-representative-sequences rep-seqs-2.qza \
  --o-table table-2.qza \
  --o-denoising-stats stats-2.qza
```

## 查看去噪过程统计
**Viewing denoising stats**
`denoise-single`命令返回去噪过程的基本统计，可以使用如下命令可视化。

```
qiime metadata tabulate \
  --m-input-file stats-1.qza \
  --o-visualization denoising-stats-1.qzv
qiime metadata tabulate \
  --m-input-file stats-2.qza \
  --o-visualization denoising-stats-2.qzv
```

## 合并不同批的代表序列和特征表
**Merging denoised data**
在这个分析中，`denoise-single`命令是最后一步，它需要对每批数据独立处理。因此，我们必须合并由这两个命令生成的对象，才能继续下游分析。首先我们将合并两个`FeatureTable[Frequency]`对象，然后合并两个`FeatureData[Sequence]`对象。这种操作是可行的，因为在每次去噪`denoise-single`单次运行中生成的特征id是可以直接比较的（在这种情况下，特征id是定义特征序列的md5值(散列/哈希))。

**合并两组数据特征表**

```
qiime feature-table merge \
  --i-tables table-1.qza \
  --i-tables table-2.qza \
  --o-merged-table table.qza
```

当然也可以继续增加更多的批次数据，只要使用更多次的`--i-tables`参数即可
  
**合并两组数据的代表序列**

```
qiime feature-table merge-seqs \
  --i-data rep-seqs-1.qza \
  --i-data rep-seqs-2.qza \
  --o-merged-data rep-seqs.qza
```

特征表数据需要进行**特征表统计**，查看基本情况。

```
qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file sample-metadata.tsv
```

### 表1. 特征表总结

Metric|	Sample
---|---
Number of samples|	121
Number of features|	337
Total frequency|	48,925

### 表2. 样品数据量分布

Type |Frequency
---|---
Minimum frequency|	84.0
1st quartile|	276.0
Median frequency|	380.0
3rd quartile|	492.0
Maximum frequency|	860.0
Mean frequency|	404.3388429752066

### 表3. 特征表频率统计

Type |Frequency
---|---
Minimum frequency|	2.0
1st quartile|	9.0
Median frequency|	24.0
3rd quartile|	85.0
Maximum frequency|	10,832.0
Mean frequency|	145.1780415430267

> 详者注：通过上表，我们可以确定特征表标准化时数据重抽样的参数，由于本测试，只用了文章原始数据的10%的数据，数据量很小，最小值为84，第一分位数为276，我们可选择276保留75%以上的样品。一般最小值1000，推荐5000以上，如果数据量都很大3-5万更好。
> 问题1. 基于`table.qzv`中的信息，在运行`qiime diversity core-metrics-phylogenetic`时，您将为`--p-sampling-depth`参数选择什么值？
> 问题2. 生成`qiime dada2 denoise-single`单批次数据结果汇总表中，查看第一批数据中定义了多少特性？在第二批数据中定义了多少特性？这些数字与合并后的特性总数相比如何？
我们还将生成合并后的`FeatureData[Sequence]`对象的摘要。在进行分析时，可以使用此摘要获得感兴趣特性的额外信息。

**代表序列统计**

```
qiime feature-table tabulate-seqs \
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs.qzv
```

输出可视化结果:

- `rep-seqs.qzv`：合并的代表性序列统计结果。 [查看](https://view.qiime2.org/?src=https%3A%2F%2Fdocs.qiime2.org%2F2021.2%2Fdata%2Ftutorials%2Ffmt%2Frep-seqs.qzv) | [下载](https://docs.qiime2.org/2021.2/data/tutorials/fmt/rep-seqs.qzv)

![image](http://bailab.genetics.ac.cn/markdown/qiime2/fig/2019.7.5.05.jpg)

**图5. 特征序列长度统计。**
基本统计、分位数和序列详细。可点击序列进行NCBI blast查看详细注释。

## 多样性分析

**Diversity analysis**

现在我们已经获得了特征表(Feature table)`FeatureTable[Frequency]`，以及代表序列(Feature Sequences)`FeatureData[Sequence]`对象，你可以基于样本元数据来探索其微生物组成。自己尝试用上篇文章《[4人体各部位微生物组分析MovingPicture](https://mp.weixin.qq.com/s/c8ZQegtfNBHZRVjjn5Gyrw)》（2021.2版）分析方法。几个问题与个体的微生物组的纵向变化有关；可以参考[`q2-longitudinal`教程](https://docs.qiime2.org/2021.2/tutorials/longitudinal/)，后面的教程中会详细讲解，到时可以学习此类分析方法。试着回答以下问题？

1. 个体微生物组；
    1. 按个体(subject-id)分类是否存在组成差异？
    2. 按个体分类存在丰富度差异吗？
    3. 按个体分类存在均匀度差异吗？
    4. 在起始和研究终点间，个体的丰富度、均匀度、组成和UniFrac距离发生改变了吗？(尝试[`q2-longitudinal tutorial`](https://docs.qiime2.org/2019.7/tutorials/longitudinal/)中的成对差异/距离方法)
    5. 丰富度、均匀度、物种组成、UniFrac距离与是否粪菌移植FMT或其它个体元数据有什么关系？处理组和对照组随时间变化大吗？（提示：有关时间序列分析，即使现在不懂也没关系，后面的章节会详细介绍，学完后再回来回答这些问题）
2. 菌群移植；
    1. 移植几周后，患者的菌群在unweighted unifrac距离下最像供体呢(使用`qiime emperor plot`)？
    2. 移植几周后，患者的菌群在Bray-Curtis距离下最像供体；
    3. 比较两种距离结果那种更好解释；
3. 实验设计：比较粪便和试子样品采集方法；
    1. 比较不同取样方法结果中最大差别的特征？差异特征用blast，或机器学习classifier注释有什么不同？
    2. 两类样品的unweighted Unifrac和Bray-Curtis间有什么不同？
    3. 供体粪便与那种取样的结果更像？
    4. 两类取样方法的Alpha多样性存在差别吗？
4. 每个测序批次中有多少样品？在不同测序批次中是否存在系统性差异？

你已经获得了特征表、代表序列，还有你的实验设计。只需要《[4人体各部位微生物组分析MovingPicture](https://mp.weixin.qq.com/s/c8ZQegtfNBHZRVjjn5Gyrw)》（2021.2版）中`构建进化树用于多样性分析`开始往后的代码运行一遍，再交互式探索结果，上面的问题的答案不言自明。


## 参考答案代码

### 1.1 按个体(subject-id)分类是否存在组成差异？

我们要考虑个体间是否存在差异，一般从整体描述角度，多查看Beta多样性分析结果，当然也可以查看Alpha或Taxonomy的差异。这里以最常用的Bray-Curtis距离下的Beta多样性为例来回答此问题。

**进化树和多样性计算**

```
# 构建进化树用于多样性分析
time qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences rep-seqs.qza \
  --o-alignment aligned-rep-seqs.qza \
  --o-masked-alignment masked-aligned-rep-seqs.qza \
  --o-tree unrooted-tree.qza \
  --o-rooted-tree rooted-tree.qza
# Alpha和beta多样性分析，选择合适的抽样数量，观察table.qzv，仅有一个样小于1150
time qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree.qza \
  --i-table table.qza \
  --p-sampling-depth 1150 \
  --m-metadata-file sample-metadata.tsv \
  --output-dir core-metrics-results
```

我们用 https://view.qiime2.org 查看结果 `core-metrics-results/bray_curtis_emperor.qzv`，着色Color选择`subject-id`，图中可以看到不同颜色有明显分开的趋势，初步判断可能存在个体间组成差异，但还要结合统计。


### 1.2/3 按个体分类存在丰富/均匀度差异吗？

要回答这两个问题，我们将采用`diversity alpha-group-significance`统计`subject-id`组间丰富度(observed_otus/richness)和均匀度(evenness)的差异显著情况。默认计算sample-metadata.tsv中的全部分组情况。

**Alpha多样性`subject`组间显著性分析和可视化**

```
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/observed_features_vector.qza \
  --m-metadata-file sample-metadata.tsv \
  --o-visualization core-metrics-results/observed_features-group-significance.qzv
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/evenness_vector.qza \
  --m-metadata-file sample-metadata.tsv \
  --o-visualization core-metrics-results/evenness-group-significance.qzv
  
```

使用QIIME2view打开`observed_otus-group-significance.qzv`，Column切换为subject-id可以查看个体间丰富多的比对箱线图，具体是否显著，可查看下面的表格。

从整体上看，P值不显著(p-value=0.55, Kruskal-Wallis test)。具体两两比较存在一些个体显著差异(p-value < 0.05, Kruskal-Wallis test)，如查看P值在B107 (n=12)	和B159 (n=7)	组间存在显著(p = 0.031077)。但由于存在特别多组的比较，多重比较校正的q-value不显著(q-value > 0.05)

此外，此图还可以查看更多分类型分组间是否存在多样性的差别。均匀度查看`evenness-group-significance.qzv`文件即可，同理，我们发现按`subject-id`分组没有q-value < 0.05的组，但有两组存在 q-value = 0.06，在没有更好的实验候选下也值得关注。

### 1.4/5 时间序列上的统计

我们在学完后面的教程再补充答案，有基础的同行，可根据后面的章节参考代码自行尝试。

### 2. 菌群移植在时间上的Beta多样性

2. 菌群移植；
    1. 移植几周后，患者的菌群在unweighted unifrac距离下最像供体呢(使用`qiime emperor plot`)？
    2. 移植几周后，患者的菌群在Bray-Curtis距离下最像供体；
    3. 比较两种距离结果那种更好解释；

主要分析unweighted_unifrac和bray_curtis距离在主轴和时间变量上的变化

```
qiime emperor plot \
  --i-pcoa core-metrics-results/unweighted_unifrac_pcoa_results.qza \
  --m-metadata-file sample-metadata.tsv \
  --p-custom-axes week \
  --o-visualization core-metrics-results/unweighted-unifrac-emperor-week.qzv
qiime emperor plot \
  --i-pcoa core-metrics-results/bray_curtis_pcoa_results.qza \
  --m-metadata-file sample-metadata.tsv \
  --p-custom-axes week \
  --o-visualization core-metrics-results/bray-curtis-emperor-week.qzv
  
```

我们以unweighted_unifrac距离为例，查看`core-metrics-results/unweighted-unifrac-emperor-week.qzv`结果，把Color分组着色选为`week`，看到样本在week轴上展开非常好。再切换Sahpe面板，修改`treatment-group`的形状为diamond，这样可以按不同形状分清供体和受试者。看到蓝色0周时与供体更像吗？同理，可查看bray_curtis距离的结果，规律如何呢？一般个人觉得Bray-Curtis距离有更好的解释，而且有权重比无权重更可信，更有意义。在不同场景下可能有不同的解读。

还可以进一步评估样本的测序量是否饱和，或从稀疏曲线中观察各组、时间点间的变化规律

```
# Alpha稀疏曲线
time qiime diversity alpha-rarefaction \
  --i-table table.qza \
  --i-phylogeny rooted-tree.qza \
  --p-max-depth 5000 \
  --m-metadata-file sample-metadata.tsv \
  --o-visualization alpha-rarefaction.qzv
```

### 3. 实验设计：比较粪便和试子样品采集方法；


3. 实验设计：比较粪便和试子样品采集方法；
    1. 比较不同取样方法结果中最大差别的特征？差异特征用blast，或机器学习classifier注释有什么不同？（按采集方法分组计算差异ASV）
    2. 两类样品的unweighted Unifrac和Bray-Curtis间有什么不同？
    3. 供体粪便与那种取样的结果更像？
    4. 两类取样方法的Alpha多样性存在差别吗？

### 4. 每个测序批次对多少样品进行了测序？

在各种测序批次间，您是否观察到样品间的系统差异？

