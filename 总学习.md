## 准备工作
### 定义工作目录
```
wd=~/github/lpz1999/qiime2
mkdir -p $wd
```


### 进入工作目录
```
cd $wd
```


### 进入QIIME 2 conda工作环境
```
conda activate qiime2-2022.2
```

### 创建本次工作目录
```
mkdir moving-pictures
cd moving-pictures
```


## 总命令
```
#更改工作目录 cd current directory

#查看当前目录有哪些文件 ls

#创建文件夹 mkdir 文件夹名
          mkdir -p xx/yy  可建立多级文件夹
          
#删除文件夹 rm -d 文件夹名  -d diretory缩写
             -rf
             -r 就是向下递归，无论有多少级目录，一并删除
             -f 就是直接强行删除，不做任何提示的意思linux
             
#进入文件夹 cd

#帮助 --help

#换行 \

#引用 ln ../原文件夹/文件 新文件夹/ 
          -f 建立时，将同档案名删除. 
          -i 删除前进行询问.
       ln -s abc cde 建立abc的软连接
       ln abc cde 建立abc的硬连接
       
#下载 wget -c #断点续传 
           -O "文件名" "网址"  #重命名
           -P// 下载位置
           -b 后台
#重命名 mv a.text b.text
#移动 mv -i 询问是否覆盖 
         -f 直接覆盖
         -n  不覆盖
         -u 不存在或较新时才移动
```

## 导入数据
```
time qiime tools import \
  --type 数据类型 #EMPSingleEndSequences \
  --input-path 导入文件 #文件夹 包括barcodes.fastq.gz sequences.fastq.gz \
  --output-path 输出文件.qza  #emp-single-end-sequences.qza
```

## demux
**拆分样本，可视化，条形码序列与样本关联，支持单端和双端序列读取的多路分解以及序列质量信息的可视化**
```
qiime demux emp-single \
  --i-seqs emp-single-end-sequences.qza \
  --m-barcodes-file #元数据 sample-metadata.tsv \
  --m-barcodes-column barcode-sequence \
  --o-per-sample-sequences demux.qza \
  --o-error-correction-details demux-details.qza #包括Golay标签错误校正的详细
  
qiime demux summarize \
  --i-data xdemux.qza \
  --o-visualization demux.qzv
  #查看qzv 判断DADA2参数值
```
```
qiime demux
   emp-paired 解复用 EMP 协议生成的双端序列数据。
   emp-single 解复用使用 EMP 协议生成的序列数据。
   filter-samples 从解复用的数据中过滤样本。
   subsample-paired 子样本配对末端序列，无需替换。
   subsample-single 没有替换的子样本单端序列。
   summarize 汇总每个样本的计数。
```
## 质量控制方法
## DADA 2
**序列质控&生成特征表 Sequence quality control and feature table construction** \
**检测和校正（如果有可能的话）Illumina扩增序列数据的工作流程，过滤掉在测序数据中鉴定的任何phiX序列（通常存在于标记基因Illumina测序数据中，用于提高扩增子测序质量），并同时过滤嵌合序列** \
**QIIME 2特征表FeatureTable[Frequency]和一个代表性序列FeatureData[Sequence]对象，Frequency对象包含数据集中每个样本中每个唯一序列的计数（频率），Sequence对象将FeatureTable中的特征ID与序列对应**
```
# --p-trim-left m，它去除每个序列的前m个碱基(如引物、标签序列barcode)
# --p-trunc-len n，它在位置n截断每个序列。这允许用户去除序列的低质量区域、引物或标签序列等。
# 质量在30以上比较好，至少20

qiime dada2 denoise-single \
  --i-demultiplexed-seqs demux.qza \
  --p-trim-left x \
  --p-trunc-len x \
  --o-representative-sequences rep-seqs-dada2.qza \
  --o-table table-dada2.qza \
  --o-denoising-stats stats-dada2.qza
  
# stats-dada2.qza: dada2计算统计结果
# table-dada2.qza: 特征表
# rep-seqs-dada2.qza: 代表序列

# 可视化
qiime metadata tabulate \
  --m-input-file stats-dada2.qza \
  --o-visualization stats-dada2.qzv
```
```
qiime dada2 denoise-ccs 去噪和去重复单端 Pacbio CCS
            denoise-paired 去噪和去重复配对末端序列
            denoise-pyro 去噪和去重复单端焦磷酸序列
            denoise-single 去噪和去重复单端序列
```

## Deblur
```
# 按测序碱基质量过滤序列
qiime quality-filter q-score \
 --i-demux demux.qza \
 --o-filtered-sequences demux-filtered.qza \
 --o-filter-stats demux-filter-stats.qza
 
 # demux-filtered.qza: 序列质量过滤后结果
 # demux-filter-stats.qza: 序列质量过滤后结果统计
 
 # --p-trim-length n；设置为质量分数中位数开始下降至低质量区时的长度
 
 # 去噪16S
 qiime deblur denoise-16S \
  --i-demultiplexed-seqs demux-filtered.qza \
  --p-trim-length x \
  --o-representative-sequences rep-seqs-deblur.qza \
  --o-table table-deblur.qza \
  --p-sample-stats \
  --o-stats deblur-stats.qza

# deblur-stats.qza: 过程统计
# table-deblur.qza: 特征表
# rep-seqs-deblur.qza: 代表序列

# 可视化 特征表&特征序列 两种方法
qiime metadata tabulate \
  --m-input-file demux-filter-stats.qza \
  --o-visualization demux-filter-stats.qzv
qiime deblur visualize-stats \
  --i-deblur-stats deblur-stats.qza \
  --o-visualization deblur-stats.qzv
  
  # demux-filter-stats.qzv: 质量过程统计表，同上面提到的stats-dada2.qzv统计表类似
  # 样本名称、*总输入读长、*总保留高读长、截断的读长、截断后太短的读长和超过最大模糊碱基的读长的数量统计 
 ```
  
 ```
 # 特征表和特征序列汇总 FeatureTable and FeatureData summaries
 # 特性表汇总命令（feature-table summarize）将向你提供关于与每个样品和每个特性相关联的序列数量、这些分布的直方图以及一些相关的汇总统计数据的信息。
 # 特征表序列表格（feature-table tabulate-seqs）命令将提供特征ID到序列的映射，并提供链接以针对NCBI nt数据库轻松BLAST每个序列。
 
 # 可视化
 qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file sample-metadata.tsv
  
qiime feature-table tabulate-seqs \
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs.qzv
  
 #   table.qzv: 特征表统计。
 #   rep-seqs.qzv: 代表序列统计，可点击序列跳转NCBI blast查看相近序列的信息。

 ```
 
 ```
 # 构建发育树
 # 系统发育多样性度量方法，包括Faith’s Phylogenetic Diversity、weighted和unweighted UniFrac。
 # 除了每个样本的特征计数（FeatureTable[Frequency]）之外，这些度量还需要将特征彼此关联结合有根进化树。此信息将存储在一个QIIME 2对象的有根系统发育对象Phylogeny[Rooted]中。
 # q2-phylogeny插件中的align-to-tree-mafft-fasttree工作流程生成系统发育树。
 # 用mafft程序执行对FeatureData[Sequence]中的序列进行多序列比对，以创建QIIME 2对象FeatureData[AlignedSequence]\
   流程屏蔽（mask或过滤）对齐的的高度可变区(高变区)，这些位置通常被认为会增加系统发育树的噪声。
   流程应用FastTree基于过滤后的比对结果生成系统发育树。FastTree程序创建的是一个无根树，因此在本节的最后一步中，应用根中点法将树的根放置在无根树中最长端到端距离的中点，从而形成有根树。
 
qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences rep-seqs.qza \
  --o-alignment aligned-rep-seqs.qza \
  --o-masked-alignment masked-aligned-rep-seqs.qza \
  --o-tree unrooted-tree.qza \
  --o-rooted-tree rooted-tree.qza
 
 # aligned-rep-seqs.qza: 多序列比对结果。
 # masked-aligned-rep-seqs.qza: 过滤去除高变区后的多序列比对结果。
 # rooted-tree.qza: 有根树，用于多样性分析。
 # unrooted-tree.qza: 无根树。
 ```

 ```
# Alpha和beta多样性分析；Alpha and beta diversity analysis
# 使用q2-diversity插件，该插件支持计算α和β多样性指数、并应用相关的统计检验以及生成交互式可视化图表。
# 首先应用core-metrics-phylogenetic方法，该方法将FeatureTable[Frequency](特征表[频率])抽平到用户指定的测序深度，然后计算几种常用的α和β多样性指数，并使用Emperor为每个β多样性指数生成主坐标分析（PCoA）图。
# α多样性
    香农(Shannon’s)多样性指数（群落丰富度的定量度量，即包括丰富度richness和均匀度evenness两个层面）
    可观测的OTU(Observed OTUs，群落丰富度的定性度量，只包括丰富度）
    Faith’s系统发育多样性（包含特征之间的系统发育关系的群落丰富度的定性度量）
    均匀度Evenness（或 Pielou’s均匀度；群落均匀度的度量）
# β多样性
    Jaccard距离（群落差异的定性度量，即只考虑种类，不考虑丰度）
    Bray-Curtis距离（群落差异的定量度量，较常用）
    非加权UniFrac距离（包含特征之间的系统发育关系的群落差异定性度量）
    加权UniFrac距离（包含特征之间的系统发育关系的群落差异定量度量）
# --p-sampling-depth，指定重采样（即稀疏/稀疏rarefaction）深度。因为大多数多样指数对不同样本的不同测序深度敏感，所以这个脚本将随机地将每个样本的测序量重新采样至该参数值（无放回抽样）
# 通过查看上面创建的表table.qzv文件中呈现的信息，尤其是交互式可视化表格，并选择一个尽可能高的值（因此每个样本保留更多的序列）同时尽可能少地排除样本来进行选择； 
# 如是数据量都很大，选最小的即可。如果有个别数据量非常小，去除最小值再选最小值。
# 454测序时代抽平至1000条即可。目录一般采用HiSeq2500或NovaSeq6000的 PE250模式测序，通常可以采用3万或5万的标准抽平，可保留90%以上样本。过低或过高一般结果也会波动较大，不放在一起分析。

qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree.qza \
  --i-table table.qza \
  --p-sampling-depth 1103 \
  --m-metadata-file sample-metadata.tsv \
  --output-dir core-metrics-results
  
 # 数据文件
    core-metrics-results/faith_pd_vector.qza: Alpha多样性考虑进化的faith指数。 
    core-metrics-results/unweighted_unifrac_distance_matrix.qza: 无权重unifrac距离矩阵。
    core-metrics-results/bray_curtis_pcoa_results.qza: 基于Bray-Curtis距离PCoA的结果。
    core-metrics-results/shannon_vector.qza: Alpha多样性香农指数。
    core-metrics-results/rarefied_table.qza: 等量重采样后的特征表。
    core-metrics-results/weighted_unifrac_distance_matrix.qza: 有权重的unifrac距离矩阵。
    core-metrics-results/jaccard_pcoa_results.qza: jaccard距离PCoA结果。
    core-metrics-results/observed_otus_vector.qza: Alpha多样性observed otus指数。 
    core-metrics-results/weighted_unifrac_pcoa_results.qza: 基于有权重的unifrac距离的PCoA结果。 
    core-metrics-results/jaccard_distance_matrix.qza: jaccard距离矩阵。
    core-metrics-results/evenness_vector.qza: Alpha多样性均匀度指数。 
    core-metrics-results/bray_curtis_distance_matrix.qza: Bray-Curtis距离矩阵。
    core-metrics-results/unweighted_unifrac_pcoa_results.qza: 无权重的unifrac距离的PCoA结果
    
# 可视化结果
    core-metrics-results/unweighted_unifrac_emperor.qzv：无权重的unifrac距离PCoA结果采用emperor可视化。 
    core-metrics-results/jaccard_emperor.qzv：jaccard距离PCoA结果采用emperor可视化。
    core-metrics-results/bray_curtis_emperor.qzv： Bray-Curtis距离PCoA结果采用emperor可视化。
    core-metrics-results/weighted_unifrac_emperor.qzv： 有权重的unifrac距离PCoA结果采用emperor可视化。
    
# 分类元数据列和alpha多样性数据之间的关系。我们将在这里为Faith系统发育多样性（群体丰富度的度量）和Evenness均匀度进行可视化操作。
# Alpha多样性组间显著性分析和可视化
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/faith_pd_vector.qza \
  --m-metadata-file sample-metadata.tsv \
  --o-visualization core-metrics-results/faith-pd-group-significance.qzv
qiime diversity alpha-group-significance \
  --i-alpha-diversity core-metrics-results/evenness_vector.qza \
  --m-metadata-file sample-metadata.tsv \
  --o-visualization core-metrics-results/evenness-group-significance.qzv
  
# 连续的样本元数据列（例如，days-since-experiment-start）不与α多样性有相关联，可以使用qiime diversity alpha-correlation命令
```

```
# 使用PERMANOVA方法（Anderson 2001年的文章中首次描述）beta-group-significance分析分类型元数据的样本组间差异。以下命令将测试一组样本之间的距离，是否比来自其他组的样本彼此更相似。
# --p-pairwise参数，将执行成对检验，结果将允许我们确定哪对特定组（例如，舌头和肠）彼此不同是否显著不同。
# 命令运行慢，因此，我们将在元数据的特定列上运行该命令，而不是在其适用的所有元数据列上运行该命令。这里，我们将使用两个示例元数据列将此应用到未加权的UniFrac距离，如下所示。

#多组或多样本时计算量指数增长
qiime diversity beta-group-significance \
  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file sample-metadata.tsv \
  --m-metadata-column body-site \
  --o-visualization core-metrics-results/unweighted-unifrac-body-site-significance.qzv \
  --p-pairwise

#多组或多样本时计算量指数增长
qiime diversity beta-group-significance \
  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file sample-metadata.tsv \
  --m-metadata-column subject \
  --o-visualization core-metrics-results/unweighted-unifrac-subject-group-significance.qzv \
  --p-pairwise
  
同样，我们对于这个数据集所拥有的连续样本元数据中没有一个与样本组成相关，因此这里我们不会测试这些关联。如果你对执行这些测试感兴趣，那么可以使用qiime metadata distance-matrix结合qiime diversity mantel和qiime diversity bioenv命令组合使用。
```

```
# 排序是在样本元数据分组间探索微生物群落组成差异的流行方法。我们可以使用Emperor工具在示例元数据下探索主坐标分析（PCoA）绘图。虽然我们的core-metrics-phylogenetic命令已经生成了一些Emperor图，但我们希望传递一个可选的参数--p-custom-axes，这对于探索时间序列数据非常有用。采于core-metrics-phylogeny的PCoA结果也是一样的，这使得很容易与Emperor生成新的可视化。我们将采用未加权的UniFrac和Bray-Curtis的PCoA结果生成Emperor图，以便所得到的图将包含主坐标1、主坐标2和实验开始以来的天数(days since the experiment start)的轴。我们将使用最后一个轴来探索这些样本是如何随时间变化的。

qiime emperor plot \
  --i-pcoa core-metrics-results/unweighted_unifrac_pcoa_results.qza \
  --m-metadata-file sample-metadata.tsv \
  --p-custom-axes days-since-experiment-start \
  --o-visualization core-metrics-results/unweighted-unifrac-emperor-days-since-experiment-start.qzv

qiime emperor plot \
  --i-pcoa core-metrics-results/bray_curtis_pcoa_results.qza \
  --m-metadata-file sample-metadata.tsv \
  --p-custom-axes days-since-experiment-start \
  --o-visualization core-metrics-results/bray-curtis-emperor-days-since-experiment-start.qzv
```

```
#Alpha稀疏曲线; Alpha rarefaction plotting

# 使用qiime diversity alpha-rarefaction可视化工具来探索α多样性与采样深度的关系。该可视化工具在多个采样深度处计算一个或多个α多样性指数，范围介于1（可选地--p-min-depth控制）和最大采样深度--p-max-depth提供值之间。在每个采样深度，将生成10个抽样表，并对表中的所有样本计算alpha多样性指数计算。迭代次数（在每个采样深度计算的稀疏表）可以通过--p-iterations来控制。在每个采样深度，将为每个样本绘制平均多样性值，如果提供样本元数据--m-metadata-file参数，则可以基于元数据对样本进行分组。

qiime diversity alpha-rarefaction \
  --i-table table.qza \
  --i-phylogeny rooted-tree.qza \
  --p-max-depth X \
  --m-metadata-file sample-metadata.tsv \
  --o-visualization alpha-rarefaction.qzv
  
  #  alpha-rarefaction.qzv: 稀疏曲线
  # 可视化将有两个图。顶部图是α稀疏图(rarefaction plot)，主要用于确定样品的丰度是否已被完全观察或测序。如果图中的线条在沿x轴的某个采样深度处看起来“平坦(level out)”（即斜率接近于零），这表明收集超过该采样深度的附加序列不太可能观测到新特征。如果绘图中的线条没有变平，这可能是因为尚未充分观察样本的丰富度（由于测序的序列太少），或者它可能是在数据中仍然存在许多测序错误（被误认为是新的多样性）。

# 当通过元数据对样本进行分组时，此可视化中结果底部的绘图结果非常重要。它说明了当特征表被细化到每个采样深度时，每个组中剩余的样本数量。如果给定的采样深度d大于样本s的总频率(即，针对样本s获得的序列数)，则不可能计算采样深度d下样本s的多样性。在顶部绘图将不可靠，因为它将计算基于相对少的样本。因此，当通过元数据对样本进行分组时，必须查看底部图表，以确定顶部图表中显示的数据是否可靠的。

#注意：提供的--p-max-depth参数的值应该通过查看上面创建的table.qzv文件中呈现的“每个样本的测序量”信息来确定。一般来说，选择一个在中位数附近的值似乎很好用。如果得到的稀疏图中的线看起来没有变平，那么你可能希望增加该值。如果由于大于最大采样深度而丢失了许多样本，则减少该值。
# 测序深度不足，样本量太少，偶然性太大，导致的结果波动大但可信度不高
```

```
# 物种组成分析 Taxonomic analysis

# 我们将开始探索样本的物种组成，并将其与样本元数据再次组合。这个过程的第一步是为FeatureData[Sequence]的序列进行物种注释。我们将使用经过Naive Bayes分类器预训练的，并由q2-feature-classifier插件来完成这项工作。这个分类器是在Greengenes 13_8 99% OTU上训练的，其中序列被修剪到仅包括来自16S区域的250个碱基，该16S区域在该分析中采用V4区域的515F/806R引物扩增并测序。我们将把这个分类器应用到序列中，并且可以生成从序列到物种注释结果关联的可视化。

# 注意：物种分类器根据你特定的样品制备和测序参数进行训练时表现最好，包括用于扩增的引物和测序序列的长度。因此，一般来说，你应该按照使用q2-feature-classifier的训练特征分类器的说明来训练自己的物种分类器。我们在数据资源页面上提供了一些通用的分类器，包括基于Silva的16S分类器，不过将来我们可能会停止提供这些分类器，而让用户训练他们自己的分类器，这将与他们的序列数据最相关。

# 下载物种注释数据库制作的分类器
wget \
  -O "gg-13-8-99-515-806-nb-classifier.qza" \
  "https://data.qiime2.org/2021.2/common/gg-13-8-99-515-806-nb-classifier.qza"

# 物种注释和可视化
qiime feature-classifier classify-sklearn \
  --i-classifier gg-13-8-99-515-806-nb-classifier.qza \
  --i-reads rep-seqs.qza \
  --o-classification taxonomy.qza

qiime metadata tabulate \
  --m-input-file taxonomy.qza \
  --o-visualization taxonomy.qzv

#  taxonomy.qza: 物种注释结果。查看 | 下载
#  gg-13-8-99-515-806-nb-classifier.qza: 分类器的训练结果。
#  taxonomy.qzv: 物种注释可视化。

#用交互式条形图查看样本的分类组成。使用以下命令绘图堆叠柱状图

qiime taxa barplot \
  --i-table table.qza \
  --i-taxonomy taxonomy.qza \
  --m-metadata-file sample-metadata.tsv \
  --o-visualization taxa-bar-plots.qzv

#taxa-bar-plots.qzv: 交互式物种组成堆叠柱状图
# 可切换不同分类级别、选择10余种配色方案；切换排序类型和升降序方向。同时图中的注可鼠标悬停查看数据。
```

```
# 使用ANCOM差异丰度分析 Differential abundance testing with ANCOM
# ANCOM可用于识别不同样本组中丰度差异的特征。https://www.ncbi.nlm.nih.gov/pubmed/26028277
# 注意：差异丰度检验在微生物学分析中是一个热门的研究领域。有两个QIIME 2插件可用：q2-gneiss和q2-composition
# ANCOM是在q2-composition插件中实现的。ANCOM假设很少（小于约25%）的特征在组之间改变。如果你期望在组之间有更多的特性正在改变，那么就不应该使用ANCOM，因为它更容易出错（I类/假阴性和II类/假阳性错误都有可能增加）。因为我们预期身体部位的许多特征都会发生变化，所以在本教程中，我们将过滤完整的特征表后只包含肠道样本。然后，我们将应用ANCOM来确定哪种（如果有的话）序列变体在我们两个受试者的肠道样本中丰度存在差异。

qiime feature-table filter-samples \
  --i-table table.qza \
  --m-metadata-file sample-metadata.tsv \
  --p-where "[body-site]='gut'" \
  --o-filtered-table gut-table.qza

# gut-table.qza：只包含肠道样本的特征表。


# ANCOM基于每个样本的特征频率对FeatureTable[Composition]进行操作，但是不能容忍零。为了构建组成composition 对象，必须提供一个添加伪计数add-pseudocount（一种遗失值插补方法）的FeatureTable[Frequency]对象，这将产生FeatureTable[Composition]对象。

qiime composition add-pseudocount \
  --i-table gut-table.qza \
  --o-composition-table comp-gut-table.qza

# comp-gut-table.qza: 组成型特征表，无零值。 

# 用ANCON对两组的特征进行丰度差异的比较了。

time qiime composition ancom \
  --i-table comp-gut-table.qza \
  --m-metadata-file sample-metadata.tsv \
  --m-metadata-column subject \
  --o-visualization ancom-subject.qzv

# ancom-subject.qzv: 按Subject分类比较结果。

# 在特定的分类学层次上执行差异丰度检验，在分类级别上折叠FeatureTable[Frequency]中的特性，然后重新运行上述步骤。在本教程中，我们将特征表折叠到属级别（即Greengenes分类法的第6级）。

qiime taxa collapse \
  --i-table gut-table.qza \
  --i-taxonomy taxonomy.qza \
  --p-level 6 \
  --o-collapsed-table gut-table-l6.qza

qiime composition add-pseudocount \
  --i-table gut-table-l6.qza \
  --o-composition-table comp-gut-table-l6.qza

qiime composition ancom \
  --i-table comp-gut-table-l6.qza \
  --m-metadata-file sample-metadata.tsv \
  --m-metadata-column subject \
  --o-visualization l6-ancom-subject.qzv

#    gut-table-l6.qza: 按属水平折叠的特征表。
#   comp-gut-table-l6.qza: 属水平筛选肠样本的相对丰度组成表
#    l6-ancom-Subject.qzv: 属水平差异比较结果。
```
